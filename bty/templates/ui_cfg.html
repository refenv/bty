{% extends "ui.html" %}
{% block title %}Configuration{% endblock %}
{% block content %}

<div class="container">
<form id="bulk_action" method="post" role="form">

<div class="card">
  <div class="card-header">
    <div class="jumbotron">
      <div class="container">
        <h1 class="display-4">Welcome to BTY</h1>
        <p class="lead">
        I like to boot it, boot it...
        I like to boot it, boot it...
        I like to boot it, boot it...
        We like to boot it!
        </p>
      </div>
    </div>

    <ul class="nav nav-tabs card-header-tabs" id="myTab" role="tablist">
      <li class="nav-item">
        <a class="nav-link active"
           id="machines-tab"
           data-toggle="tab"
           href="#machines"
           role="tab"
           aria-controls="machines"
          aria-selected="true">Machines</a>
      </li>
      <li class="nav-item">
        <a class="nav-link"
           id="pconfigs-tab"
           data-toggle="tab"
           href="#pconfigs"
           role="tab"
           aria-controls="pconfigs"
          aria-selected="false">PXE Configs</a>
      </li>
      <li class="nav-item">
        <a class="nav-link"
           id="ptemplates-tab"
           data-toggle="tab"
           href="#ptemplates"
           role="tab"
           aria-controls="ptemplates"
          aria-selected="false">PXE Templates</a>
      </li>
      <li class="nav-item">
        <a class="nav-link"
           id="images-tab"
           data-toggle="tab"
           href="#images"
           role="tab"
           aria-controls="images"
           aria-selected="false">Images</a>
      </li>
      <li class="nav-item">
        <a class="nav-link"
           id="craw-tab"
           data-toggle="tab"
           href="#craw"
           role="tab"
           aria-controls="craw"
           aria-selected="false">Raw</a>
      </li>
    </ul>
  </div>

  <div class="tab-content" id="MyTabContent">
    <div class="tab-pane show active" id="machines" role="tabpanel"
      aria-labelledby="machines-tab">

      <div class="card-body">
        <h5 class="card-title">Machine Management / Configuration</h5>
        <p class="card-text">
        This is where you setup and control what to do with discovered machines. Manage them? And if so,
        then which image should be installed and which PXE template should be used along with the
        default PXE label.
        </p>
      </div>

      <table class="table table-striped" id="machine_list">
        <thead>
          <tr>
            <th>Hostname</th>
            <th>HWA</th>
            <th>PXE Tmpl.</th>
            <th>PXE Lbl.</th>
            <th>Image</th>
            <th>Managed</th>
            <th><input type="checkbox" name="bulk_selector" id="bulk_selector"></th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th scope="row" colspan="5">No machines</p></th>
          </tr>
        </tbody>
      </table>

      <div class="card-footer text-muted">
        <button class="btn btn-primary" type="submit" name="action" value="apply">Apply Changes</button>
        <div class="float-right">
          or with <b>selected</b> hosts do:
          <div class="btn-group">
            <button class="btn btn-success" type="submit" name="action" value="refresh">(Re)write PXE</button>
            <button class="btn btn-danger" type="submit" name="action" value="remove">Remove</button>
          </div>
        </div>
      </div>

    </div> <!-- machines -->

    <div class="tab-pane" id="pconfigs" role="tabpanel" aria-labelledby="pconfigs-tab">

      <div class="card-body">
        <h5 class="card-title">PXE Configs available to PXE</h5>
        <p class="card-text">
        These are the PXE configurations available to PXE, that is.
        </p>
      </div>

      <table class="table table-striped" id="ptemplate_list">
        <thead>
          <tr>
            <th>Filename</th>
            <th>Labels</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th scope="row" colspan="2">No templates</p></th>
          </tr>
        </tbody>
      </table>

      <div class="card-footer text-muted">
        <button class="btn btn-primary" type="submit" name="action" value="pconfigs_reload">
          Reload PXE Configs
        </button>
      </div>
    </div> <!-- pconfigs -->

    <div class="tab-pane" id="ptemplates" role="tabpanel" aria-labelledby="ptemplates-tab">
      <div class="card-body">
        <h5 class="card-title">PXE Templates available to BTY</h5>
        <p class="card-text">
        Add additional in PXE templates directory and then reload, the PXE template importer will
        parse <b>LABEL</b> statements from the template and provide them here.
        </p>
      </div>

      <table class="table table-striped" id="ptemplate_list">
        <thead>
          <tr>
            <th>Filename</th>
            <th>Labels</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th scope="row" colspan="2">No templates</p></th>
          </tr>
        </tbody>
      </table>

      <div class="card-footer text-muted">
        <button class="btn btn-primary" type="submit" name="action" value="ptemplates_reload">
          Reload PXE Templates
        </button>
      </div>
    </div> <!-- ptemplates -->

    <div class="tab-pane" id="images" role="tabpanel" aria-labelledby="images-tab">
      <div class="card-body">
        <h5 class="card-title">Disk Images made available via NFS and HTTP</h5>
        <p class="card-text">
        If you want to add additional images then, simply store them in **INSERT_PATH_HERE**.
        </p>
      </div>

      <table class="table table-striped" id="ptemplate_list">
        <thead>
          <tr>
            <th>Filename</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th scope="row" colspan="1">No images</p></th>
          </tr>
        </tbody>
      </table>

      <div class="card-footer text-muted">
        <button class="btn btn-primary" type="submit" name="action" value="images_reload">
          Reload Disk Images
        </button>
      </div>
    </div> <!-- images -->

    <div class="tab-pane" id="craw" role="tabpanel" aria-labelledby="craw-tab">
      <div class="card-body">
        <h5 class="card-title">Raw Configuration dump</h5>
        <p class="card-text">
        The BTY UI provides a couple of means view and change the BTY configuration. However, there
        might be values you want to look at, or intergrate BTY in some other form. For that you can
        go directly to the JSON representation.

        Click the button below to get the raw configuration.
        </p>
      </div>

      <div class="card-footer text-muted">
        <a href="/cfg" class="btn btn-primary" role="button">Goto Raw Config</a>
      </div>
    </div> <!-- craw -->

  </div>

</form>
</div>

{% endblock %}

{% block script %}
<script type="text/javascript">

var DEFAULT_SORT_KEY = "hostname";
var DEFAULT_SORT_DIR = "ASC";

function init_list(cfg, sort_attr, sort_dir) {

  var machines = new Array();                    // Convert dict of machines to list of machines
  $.each(cfg.machines, function(i, machine) {
    machines.push(machine);
  });

  var images = new Array();
  $.each(cfg.img.lst, function(i, image) {
    images.push(image);
  });
  images.push("null");  // Also adding the 'null' / not selected
  images.sort();

  var pxe_labels = new Array();
  $.each(cfg.pxe.labels, function(i, label) {
    pxe_labels.push(label);
  });
  pxe_labels.push("null");  // Also adding the 'null' / not selected
  pxe_labels.sort();

  var pxe_templates = new Array();
  $.each(cfg.pxe.templates, function(i, template) {
    pxe_templates.push(template);
  });
  pxe_templates.push("null");  // Also adding the 'null' / not selected
  pxe_templates.sort();

  function fill() {
    $("#machine_list").find("tbody").empty();   // Remove tbody content

    machines.sort(function(a, b) {
      var attrA = String(a[sort_attr]).toUpperCase();
      var attrB = String(b[sort_attr]).toUpperCase();

      if (sort_dir == "ASC") {
        if (attrA < attrB)
          return -1;
        if (attrA > attrB)
          return 1;
      } else {
        if (attrA > attrB)
          return -1;
        if (attrA < attrB)
          return 1;
      }

      // names must be equal
      return 0;
    });

    $.each(machines, function(i, machine) {     // Populate
      var row = $("<tr>");

      if (machine && "exists" in machine) {
        row.addClass(machine.exists ? "success" : "danger");
      }

      row.append($("<td>").append(
            $("<input>")
            .prop("type", "text")
            .prop("name", "hostname")
            .val(String(machine.hostname))
      ));

      row.append($("<th>").append(
        $("<input>")
        .prop("type", "text")
        .prop("name", "hwa")
        .prop("readonly", "true")
        .val(String(machine.hwa))
        .text(String(machine.hwa))
      ));

      row.append($("<td>").append($("<select>").prop("name", "pxe_tmpl_fname").prop("class",
              "form-control")));
      row.append($("<td>").append($("<select>").prop("name", "pxe_conf_label").prop("class",
            "form-control")));

      // Image selector
      var img_selector = $("<select>").prop("name", "img").prop("class", "form-control");

      $.each(images, function(i, image) {
        $("<option>").val(image).text(image).appendTo(img_selector);
      });
      $(img_selector).val(String(machine.image));

      row.append($("<td>").append(img_selector));

      // PXE selector
      /*
      var pxe_selector = $("<select>").prop("name", "pxe").prop("class", "form-control");

      $.each(pxe_labels, function(i, lbl) {
        $("<option>").val(lbl).text(lbl).appendTo(pxe_selector);
      });
      $(pxe_selector).val(String(machine.pxe.lbl));

      row.append($("<td>").append(img_selector));
      */

      row.append($("<td>").append(
        $("<select>")
        .prop("class", "form-control")
        .append($("<option>").val("1").text("True"))
        .append($("<option>").val("0").text("False"))
        .val(String(machine.managed === true ? "1" : "0"))
      ));

      row.append($("<td>").append(
        $("<input>")
        .prop("type", "checkbox")
        .prop("name", "bulk_ident")
        .val(machine.hwa)
      ));

      row.appendTo($("#machine_list tbody"));
    });

  }

  // Event listeners
  $("#machine_list thead th").click(function(evt, e) {

    new_sort_attr = String($(this).text().toLowerCase());
    if (new_sort_attr.length < 3)
      return;

    if (new_sort_attr == sort_attr) {
      sort_dir = sort_dir == "DESC" ? "ASC" : "DESC";
    } else {
      sort_attr = new_sort_attr;
      sort_dir = DEFAULT_SORT_DIR
    }

    fill();
  });

  $("#bulk_selector").click(function() {
    $(this)
    .closest('form')
    .find(':checkbox')
    .prop("checked", $(this).prop("checked"));
  });

  fill();
}

function main(cfg) {
  init_list(cfg, DEFAULT_SORT_KEY, DEFAULT_SORT_DIR);
}

</script>
{{ super() }}
{% endblock script %}
