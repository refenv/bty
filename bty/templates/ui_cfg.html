{% extends "ui.html" %}
{% block title %}Configuration{% endblock %}
{% block content %}

<form id="bulk_action" method="post" role="form">
<table class="table table-striped" id="machine_list">
  <thead>
    <tr>
      <th><input type="checkbox" name="bulk_selector" id="bulk_selector"></th>
      <th>Hostname</th>
      <th>HWA</th>
      <th>Image</th>
      <th>PXE Lbl.</th>
      <th>PXE Tmpl.</th>
      <th>Managed</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th scope="row" colspan="5">No machines</p></th>
    </tr>
  </tbody>
</table>

<button class="btn btn-primary" type="submit" name="action" value="apply">Apply Changes</button>

<div class="panel-footer">With selection do:
  <div class="btn-group">
    <button class="btn btn-success" type="submit" name="action" value="refresh">(Re)write PXE</button>
    <button class="btn btn-danger" type="submit" name="action" value="remove">Remove</button>
  </div>
</div>
</form>

{% endblock %}

{% block script %}
<script type="text/javascript">

function init_list(cfg, sort_attr, sort_dir) {

  var machines = new Array();                    // Convert dict of machines to list of machines
  $.each(cfg.machines, function(i, machine) {
    machines.push(machine);
  });

  var images = new Array();
  $.each(cfg.img.lst, function(i, image) {
    images.push(image);
  });
  images.push("null");  // Also adding the 'null' / not selected
  images.sort();

  var pxe_labels = new Array();
  $.each(cfg.pxe.labels, function(i, label) {
    pxe_labels.push(label);
  });
  pxe_labels.push("null");  // Also adding the 'null' / not selected
  pxe_labels.sort();

  function fill() {
    $("#machine_list").find("tbody").empty();   // Remove tbody content

    machines.sort(function(a, b) {
      var attrA = String(a[sort_attr]).toUpperCase();
      var attrB = String(b[sort_attr]).toUpperCase();

      if (sort_dir == "ASC") {
        if (attrA < attrB)
          return -1;
        if (attrA > attrB)
          return 1;
      } else {
        if (attrA > attrB)
          return -1;
        if (attrA < attrB)
          return 1;
      }

      // names must be equal
      return 0;
    });

    $.each(machines, function(i, machine) {     // Populate
      var row = $("<tr>");

      if (machine && "exists" in machine) {
        row.addClass(machine.exists ? "success" : "danger");
      }

      row.append($("<td>").append(
        $("<input>")
        .prop("type", "checkbox")
        .prop("name", "bulk_ident")
        .val(machine.hwa)
      ));

      row.append($("<td>").append(
            $("<input>")
            .prop("type", "text")
            .prop("name", "hostname")
            .val(String(machine.hostname))
      ));

      row.append($("<th>").append(
        $("<input>")
        .prop("type", "text")
        .prop("name", "hwa")
        .prop("readonly", "true")
        .val(String(machine.hwa))
        .text(String(machine.hwa))
      ));

      // Image selector
      var img_selector = $("<select>").prop("name", "img").prop("class", "form-control");

      $.each(images, function(i, image) {
        $("<option>").val(image).text(image).appendTo(img_selector);
      });
      $(img_selector).val(String(machine.image));

      row.append($("<td>").append(img_selector));

      // PXE selector
      /*
      var pxe_selector = $("<select>").prop("name", "pxe").prop("class", "form-control");

      $.each(pxe_labels, function(i, lbl) {
        $("<option>").val(lbl).text(lbl).appendTo(pxe_selector);
      });
      $(pxe_selector).val(String(machine.pxe.lbl));

      row.append($("<td>").append(img_selector));
      */

      row.append($("<td>").append(
        $("<select>")
        .prop("class", "form-control")
        .append($("<option>").val("1").text("True"))
        .append($("<option>").val("0").text("False"))
        .val(String(machine.managed === true ? "1" : "0"))
      ));

      row.appendTo($("#machine_list tbody"));
    });

  }

  // Event listeners
  $("#machine_list thead th").click(function(evt, e) {

    new_sort_attr = String($(this).text().toLowerCase());
    if (new_sort_attr.length < 3)
      return;

    if (new_sort_attr == sort_attr) {
      sort_dir = sort_dir == "DESC" ? "ASC" : "DESC";
    } else {
      sort_attr = new_sort_attr;
    }

    fill();
  });

  $("#bulk_selector").click(function() {
    $(this)
    .closest('form')
    .find(':checkbox')
    .prop("checked", $(this).prop("checked"));
  });

  fill();
}

function main(cfg) {
  init_list(cfg, "hostname", "ASC");
}

</script>
{{ super() }}
{% endblock script %}
